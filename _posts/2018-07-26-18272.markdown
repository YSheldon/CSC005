---
layout: post
title: Microsoft Office Vulnerabilities Used to Distribute FELIXROOT Backdoor in Recent Campaign
date: 2018-07-26 01:02:20
tourl: /blog/threat-research/2018/07/microsoft-office-vulnerabilities-used-to-distribute-felixroot-backdoor.html
tags: [FIREEYE,Equation,Rundll32,Exploitation,Windows Management Instrumentation]
---
In September 2017, FireEye identified the FELIXROOT backdoor as a payload in a campaign targeting Ukrainians and reported it to our intelligence customers. The campaign involved malicious Ukrainian bank documents, which contained a macro that downloaded a FELIXROOT payload, being distributed to targets.FireEye recently observed the same FELIXROOT backdoor being distributed as part of a newer campaign. This time, weaponized lure documents claiming to contain seminar information on environmental protection were observed exploiting known Microsoft Office vulnerabilities The malware is distributed via Russian-language documents (Figure 2) that are weaponized with known Microsoft Office vulnerabilities. In this campaign, we observed threat actors exploiting CVE-2017-0199 and CVE-2017-11882 to distribute malware. The malicious document used is named Seminar.rtf. It exploits CVE-2017-0199 to download the second stage payload from 193.23.181.151 (Figure 3). The downloaded file is weaponized with CVE-2017-11882.Figure 4 shows the first payload trying to download the second stage Seminar.rtf.The downloaded Seminar.rtf contains an embedded binary file that is dropped in %temp% via Equation Editor executable. This file drops the executable at %temp% (MD5: 78734CD268E5C9AB4184E1BBE21A6EB9), which is used to drop and execute the FELIXROOT dropper component (MD5: 92F63B1227A6B37335495F9BCB939EA2).The dropped executable (MD5: 78734CD268E5C9AB4184E1BBE21A6EB9) contains the compressed FELIXROOT dropper component in the Portable Executable (PE) binary overlay section. When it is executed, it creates two files: an LNK file that points to %system32%undll32.exe, and the FELIXROOT loader component. The LNK file is moved to the startup directory. Figure 5 shows the command in the LNK file to execute the loader component of FELIXROOT.The embedded backdoor component is encrypted using custom encryption. The file is decrypted and loaded directly in memory without touching the disk.After successful exploitation, the dropper component executes and drops the loader component. The loader component is executed via RUNDLL32.EXE. The backdoor component is loaded in memory and has a single exported function.Strings in the backdoor are encrypted using a custom algorithm that uses XOR with a 4-byte key. Decryption logic used for ASCII strings is shown in Figure 6.Decryption logic used for Unicode strings is shown in Figure 7.Upon execution, a new thread is created where the backdoor sleeps for 10 minutes. Then it checks to see if it was launched by RUNDLL32.exe along with parameter #1. If the malware was launched by RUNDLL32.exe with parameter #1, then it proceeds with initial system triage before doing command and control (C2) network communications. Initial triage begins with connecting to Windows Management Instrumentation (WMI) via the ROOTCIMV2 namespace.Figure 8 shows the full operation.Table 1 shows the classes referred from the ROOTCIMV2 and RootSecurityCenter2 namespace.Win32_OperatingSystemWin32_ComputerSystemAntiSpywareProductAntiVirusProductFirewallProductWin32_UserAccountWin32_NetworkAdapterWin32_ProcessRegistry entries are read for potential administration escalation and proxy information.Table 2 shows FELIXROOT backdoor capabilities. Each command is performed in an individual thread.0x31Fingerprint System via WMI and Registry0x32Drop File and execute0x33Remote Shell0x34Terminate connection with C20x35Download and run batch script0x36Download file on machine0x37Upload FileFigure 9 shows the log message decrypted from memory using the same mechanism shown in Figure 6 and Figure 7 for every command executed.FELIXROOT communicates with its C2 via HTTP and HTTPS POST protocols. Data sent over the network is encrypted and arranged in a custom structure. All data is encrypted with AES, converted into Base64, and sent to the C2 server (Figure 10).All other fields, such as User-Agents, Content-Type, and Accept-Encoding, that are part of the request / response header are XOR encrypted and present in the malware. The malware queries the Windows API to get the computer name, user name, volume serial number, Windows version, processor architecture and two additional values, which are 1.3 and KdfrJKN. The value KdfrJKN may be used as identification for the campaign and is found in the JOSN object in the file (Figure 11).The FELIXROOT backdoor has three parameters for C2 communication. Each parameter provides information about the task performed on the target machine (Table 3).u=This parameter contains target machine information in the following format:Computer Name, User Name, Windows Versions, Processor Architecture, 1.3,KdfrJKN , Volume Serial Numberh=This parameter includes the information about the command executed and its results.p=This parameter contains the information about data associated with the C2 server.All data is transferred to C2 servers using AES encryption and the After encryption, the cipher text to be sent over C2 is Base64 encoded. Figure 15 shows the structure used to send data to the server, and Figure 16 shows the structural representation of data used in C2 communications.The structure is converted to Base64 using the FELIXROOT backdoor contains several commands for specific tasks. After execution of every task, the malware sleeps for one minute before executing the next task. Once all the tasks have been executed completely, the malware breaks the loop, sends the termination buffer back, and clears all the footprints from the targeted machine:CVE-2017-0199 and CVE-2017-11882 are two of the more commonly exploited vulnerabilities that we are currently seeing. Threat actors will increasingly leverage these vulnerabilities in their attacks until they are no longer finding success, so organizations must ensure they are protected. At this time of writing, FireEye Multi Vector Execution (MVX) engine is able to recognize and block this threat. We also advise that all industries remain on alert, as the threat actors involved in this campaign may eventually broaden the scope of their current targeting.11227ECA89CC053FB189FAC3EBF27497Seminar.rtf4DE5ADB865B5198B4F2593AD436FCEFFSeminar.rtf78734CD268E5C9AB4184E1BBE21A6EB9ZamRandomNumber.doc92F63B1227A6B37335495F9BCB939EA2FELIXROOT DropperDE10A32129650849CEAF4009E660F72FFELIXROOT Backdoor217.12.104.100/news217.12.204.100:443/news193.23.181.151/Seminar.rtfAccept-Encoding: gzip, deflatecontent-Type: application/x-www-form-urlencodedMozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; InfoPath.2)Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; InfoPath.2)Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; InfoPath.2)Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; InfoPath.2){"1" : "https://88.198.13.116:8443/xmlservice","2" : "30","4" : "GufseGHbc","6" : "3", "7" :http://88.198.13.116:8080/xmlservice"}{"1" : "https://217.12.204.100/news/","2" : "30","4" : "KdfrJKN","6" : "3", "7" :"http://217.12.204.100/news/"}MD5ProductSignatureAction11227ECA89CC053FB189FAC3EBF27497NX/EX/AXMalware.Binary.rtfBlock4DE5ADB865B5198B4F2593AD436FCEFFNX/EX/AXMalware.Binary.rtfBlock78734CD268E5C9AB4184E1BBE21A6EB9NX/EX/AXMalware.BinaryBlock92F63B1227A6B37335495F9BCB939EA2NX/EX/AXFE_Dropper_Win32_FELIXROOT_1BlockDE10A32129650849CEAF4009E660F72FNX/EX/AXFE_Backdoor_Win32_FELIXROOT_2Block11227ECA89CC053FB189FAC3EBF27497HXIOCAlert4DE5ADB865B5198B4F2593AD436FCEFFHXIOCAlertSpecial thanks to Jonell Baltazar, Alex Berry and Benjamin Read for their contributions to this blog.